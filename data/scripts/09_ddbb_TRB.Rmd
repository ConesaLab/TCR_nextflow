---
title: "09 - Databases (antigen specificity)"
authors: "Maria Chernigovskaya and Teresa Rubio"
date: "March, 2021"
output: html_document
---

# Packages
```{r, warning=F, message=FALSE}
library(immunarch)
library(reshape2)
library(openxlsx)
```

# Work enviroment
```{r}
# Define input/work/output directories
inputDir <- "~/MHE_TCR/02_DataFiltering"
workDir <- "~/MHE_TCR/ddbb/"
outputDir <- "~/MHE_TCR/TCRanalysis_bookdown"
articleDir <- "~/MHE_TCR/TCRanalysis_articlefigures"

# Load sample info
SampleInfo <- read.csv("../samplesinfo.csv", check.names = F)
SampleInfo$Group <- factor(SampleInfo$Group, levels = unique(SampleInfo$Group))
palette <- c("#56B4E9", "red", "black")
groups_color <- palette[factor(SampleInfo$Group)]

chain <- "TRB"
```

# McPAS-TRB
The database was last updated on: March 6, 2021.
Downloaded on: March 12, 2021.
```{r}
mcpas_db <- read.csv("McPAS-TRB_human.csv", stringsAsFactor = FALSE, sep = ",")

mcpas_db <- mcpas_db[!is.na(mcpas_db$CDR3.beta.aa),]

mcpas_db$Pathology <- gsub("IBD\\).", "IBD)", mcpas_db$Pathology)
mcpas_db$Pathology <- gsub("M.Tuberculosis", "M. tuberculosis", mcpas_db$Pathology)
mcpas_db$Pathology <- gsub("Hepatitis C virus \\(HCV\\)", "Hepatitis C virus", mcpas_db$Pathology)
mcpas_db$Pathology <- gsub("HTLV-1 \\(Chronic", "HTLV-1", mcpas_db$Pathology)
mcpas_db$Pathology <- gsub("Psoriatic arthritis", "Psoriatic Arthritis", mcpas_db$Pathology)

mcpas_db_human <- subset(mcpas_db, Species == "Human" & nchar(CDR3.beta.aa) > 4)
mcpas_db_human <- subset(mcpas_db_human, Category == "Autoimmune" | Category == "Pathogens")

mcpas_db_human_melt_df <- reshape2::melt(mcpas_db_human[, c("CDR3.beta.aa", "Category", "Pathology")], 
                                         id = "CDR3.beta.aa")
```

# VDJdb-TRB
Last updated on 02 February, 2021
Downloaded on: March 12, 2021.
```{r}
VDJdb <- read.delim("VDJdb-TRB_human.tsv")

vdj_db_human <- subset(VDJdb, Species == "HomoSapiens" & nchar(CDR3) > 4)
vdj_db_human <- subset(vdj_db_human, Gene == "TRB")
```

# CDR3 sets
```{r}
cdrsets <- list()
immdata <- immunarch::repLoad(file.path(inputDir, paste0("clones_",chain,"_filtered")))

# control group
control <- immdata$data[c(SampleInfo$SampleID[SampleInfo$Group == "control"])]
control_cdrs <- unique(do.call(rbind, lapply(control, function(x) x[,"CDR3.aa",drop=F])))
cdrsets$control <- control_cdrs$CDR3.aa

# withoutMHE group
withoutMHE <- immdata$data[c(SampleInfo$SampleID[SampleInfo$Group == "withoutMHE"])]
withoutMHE_cdrs <- unique(do.call(rbind, lapply(withoutMHE, function(x) x[,"CDR3.aa",drop=F])))
cdrsets$withoutMHE <- withoutMHE_cdrs$CDR3.aa

# withMHE group
withMHE <- immdata$data[c(SampleInfo$SampleID[SampleInfo$Group == "withMHE"])]
withMHE_cdrs <- unique(do.call(rbind, lapply(withMHE, function(x) x[,"CDR3.aa",drop=F])))
cdrsets$withMHE <- withMHE_cdrs$CDR3.aa
```


# Statistical test
## ref db = mcpas
The p-values are adjusted for multiple testing using Benjamini-Hochberg FDR correction considering both the number of diseases and the number of sample groups tested.
```{r}
# db : reference database (mcpas)
# cdr3 : data (CDR3 sets)
# disease : disease name (e.g. HIV, CMV, etc)
get_stats <- function(db, cdr3, disease) {
  disease_cdr3 <- unique(db$CDR3.beta.aa[db$Pathology == disease])
  cont_table <- table(unique(db$CDR3.beta.aa) %in% cdr3, unique(db$CDR3.beta.aa) %in% disease_cdr3)
  rownames(cont_table) <- c("not_in_data", "in_data")
  colnames(cont_table) <- c("not_in_disease","in_disease")
  pval <- fisher.test(cont_table, alternative = "great")$p.value
  return(pval)
}

pvalues <- do.call(cbind, lapply(cdrsets, function(cdr3set){
  diseases <- unique(mcpas_db_human$Pathology)
  pvals <- rep(NA, length(diseases))
  
  for (i in 1:length(diseases)) {
    pvals[i] <- get_stats(db = mcpas_db_human, cdr3 = cdr3set, disease = diseases[i])
    names(pvals)[i] <- diseases[i]
  }
  
  return(pvals)
  
}))

adj_pval <- matrix(p.adjust(pvalues, method = "fdr"), nrow = 28, ncol = 3)
rownames(adj_pval) <- rownames(pvalues)
colnames(adj_pval) <- colnames(pvalues)
adj_pval <- adj_pval[order(rownames(adj_pval)),]

openxlsx::write.xlsx(data.frame(adj_pval), file = file.path(articleDir, "Supplementary Table 2.xlsx"), rowNames = T)

write.csv(data.frame(adj_pval), file = file.path(outputDir, "09_ddbb_Fisher_mcpasTRB.csv"), row.names = T)
```


## ref db = vdjdb
```{r}
# db : reference database (vdjdb)
# cdr3 : data (CDR3 sets)
# disease : disease name (e.g. HIV, CMV, etc)
get_stats <- function(db, cdr3, disease) {
  disease_cdr3 <- unique(db$CDR3[db$Epitope.species == disease])
  cont_table <- table(unique(db$CDR3) %in% cdr3, unique(db$CDR3) %in% disease_cdr3)
  rownames(cont_table) <- c("not_in_data", "in_data")
  colnames(cont_table) <- c("not_in_disease","in_disease")
  pval <- fisher.test(cont_table, alternative = "great")$p.value
  return(pval)
}

pvalues = do.call(cbind, lapply(cdrsets, function(cdr3set){
  diseases <- unique(vdj_db_human$Epitope.species)
  pvals <- rep(NA, length(diseases))
  
  for (i in 1:length(diseases)) {
    pvals[i] <- get_stats(db = vdj_db_human, cdr3 = cdr3set, disease = diseases[i])
    names(pvals)[i] <- diseases[i]
  }
  
  return(pvals)
  
}))

adj_pval <- matrix(p.adjust(pvalues, method = "fdr"), nrow = 20, ncol = 3)
rownames(adj_pval) <- rownames(pvalues)
colnames(adj_pval) <- colnames(pvalues)
adj_pval = adj_pval[order(rownames(adj_pval)),]

openxlsx::write.xlsx(data.frame(adj_pval), file = file.path(articleDir, "Supplementary Table 3.xlsx"), rowNames = T)

write.csv(data.frame(adj_pval), file = file.path(outputDir, "09_ddbb_Fisher_vdjdbTRB.csv"), row.names = T)
```
